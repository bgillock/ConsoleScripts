<script>

var file1Lines = []
var file2Lines = []
var file1Name = ""
var file2Name = ""
/* 
/ch/09/config "Acoustic" 23 YE 5
/ch/09/delay OFF   0.3
/ch/09/preamp +0.0 OFF ON 24 132
/ch/09/gate OFF GATE -56.5 11.0 0 10.0  315 0
/ch/09/gate/filter OFF 3.0 403.7
/ch/09/dyn ON COMP PEAK LOG -25.0 3.0 2 0.00 16 0.02  72 PRE 0 100 OFF
/ch/09/dyn/filter OFF 3.0 990.9
/ch/09/insert OFF POST OFF
/ch/09/eq ON
/ch/09/eq/1 PEQ 248.9 -0.25 9.5
/ch/09/eq/2 PEQ 1k02 +0.00 0.6
/ch/09/eq/3 PEQ 2k99 -6.50 1.0
/ch/09/eq/4 HShv 5k02 -4.25 1.0
/ch/06/mix OFF  -0.8 ON +100 ON   -oo
/ch/06/mix/01 ON   -oo +100 EQ-> 0
/ch/06/mix/02 ON   -oo
/ch/06/mix/03 ON   -oo +100 EQ-> 0
/ch/06/mix/04 ON   -oo
/ch/06/mix/05 ON   -oo +100 EQ-> 0
/ch/06/mix/06 ON   -oo
/ch/06/mix/07 ON   -oo +100 EQ-> 0
/ch/06/mix/08 ON   -oo
/ch/06/mix/09 ON   -oo +100 POST 0
/ch/06/mix/10 ON   -oo
/ch/06/mix/11 ON   0.0 +100 POST 0
/ch/06/mix/12 ON   0.0
/ch/06/mix/13 ON   -oo +100 POST 0
/ch/06/mix/14 ON  -6.0
/ch/06/mix/15 ON   -oo +100 POST 0
/ch/06/mix/16 ON   -oo
/ch/06/grp %00000100 %000001
/ch/06/automix OFF  +0.0
*/
const ParamMeta = {
    config: ["Name","Icon","Color","Source"],
    preamp: ["P1","P2","P3","P4","LowCut"],
    delay: ["On/Off","Time"],
    gate: ["On/Off","Type","Threshold","Range","Attack","Hold","Release"],
    gate_filter: ["On/Off","Type","Freq"],
    dyn: ["On/Off","Type","Peak/RMS","Log/Lin","Threshold","Ratio","Knee","Gain","Attack","Hold","Release"],
    dyn_filter: ["On/Off","Type","Freq"],
    insert: ["On/Off","Pre/Post","FX"],
    eq: ["On/Off"],
    eq_n: ["Type","Freq","Gain","Q"],
    mix: ["All","Fader","MainStereo","Pan","Mono"],
    mix_n: ["On/Off","dB","Pan","Tap","LR/Pan"]
}
const ConsoleColor = {
    WH: "color:white;background-color:black",
    WHi: "background-color:white;color:black",
    MG: "color:magenta;background-color:black",
    MGi: "background-color:magenta;color:black",
    YE: "color:yellow;background-color:black",
    YEi: "background-color:yellow;color:black",
    GN: "color:green;background-color:black",
    GNi: "background-color:green;color:black",
    CY: "color:green;background-color:black",
    CYi: "background-color:green;color:black",
}
function loadFile1(contents) {
    file1Lines = contents.split('\n')
    file1Name = file1Lines[0].split('\"')[1]
    document.getElementById('file1button').setAttribute("width",file1Name.length*10)
    document.getElementById('file1button').textContent=file1Name
}
function getParamTuples(sceneline) {
    var tuples = []
    var fields=sceneline.match(/(?:[^\s"']+|['"][^'"]*["'])+/g) // space delimited with quoted strings containing spaces
    var linetype = ""
    var tracknum = ""
    var paramgroup = ""
    if (fields == null) return [linetype, tracknum, paramgroup, tuples]
    var path=fields[0].split('/')

    if ((path[1] == 'ch') || 
        (path[1] == 'bus') || 
             (path[1] == 'fxrtn') ||
             (path[1] == 'mtx') || 
             (path[1] == 'auxin')) {
        var params = ParamMeta[path[3]]
        paramgroup = path[3]
        if (path.length == 5) {
            if (isNaN(path[4])) {
                params = ParamMeta[path[3]+'_'+path[4]]
            }
            else {
                params = ParamMeta[path[3]+'_n']
            }
            paramgroup = path[3]+'/'+path[4]
        }

        if (params) {
            for (var p=0;p<params.length;p++) {
                tuples.push([params[p],fields[p+1]])
            }
            linetype = path[1]
            tracknum = path[2]
        }
    }
    return [linetype, tracknum, paramgroup, tuples]
}
function loadFile2(contents) {
    file2Lines = contents.split('\n')
    file2Name = file2Lines[0].split('\"')[1]
    document.getElementById('file2button').setAttribute("width",file2Name.length*10)
    document.getElementById('file2button').textContent=file2Name
    var htmlout = ""
    htmlout="Before N Lines = "+String(file1Lines.length)+", After N Lines = "+String(file2Lines.length)+'\n'
    htmlout+="<table><tr><th>Type</th><th>Name</th><th>Group</th><th>Param</th><th>Before</th><th>After</th></tr>"
    if (file1Lines.length != file2Lines.length) return
    var channelName = "No Channel Name"
    var channelColor = ""
    for (var l=0;l<file2Lines.length;l++) {
        var [linetype1, tracknum1, paramgroup1, params1] = getParamTuples(file1Lines[l])
        var [linetype2, tracknum2, paramgroup2, params2] = getParamTuples(file2Lines[l])
        
        if ((params1.length > 0) && 
            ((linetype1 == 'ch') || 
             (linetype1 == 'bus') || 
             (linetype1 == 'fxrtn') ||
             (linetype1 == 'mtx') || 
             (linetype1 == 'auxin')) ) {
            if (paramgroup1 == "config") {
                channelName = "<td>"+linetype1+"</td><td>"+params2[0][1]+"</td>"
                channelColor = ConsoleColor[params2[2][1]]
            }
            for (var p=0;p<params1.length;p++) {
                if (params1[p][1] != params2[p][1])
                {
                    htmlout+='<tr style=\"'+channelColor+'\">'+
                        channelName+'<td>'+paramgroup1+'</td>'+
                            '<td>'+params1[p][0]+'</td><td>'+params1[p][1]+'</td><td>'+params2[p][1]+'</td></tr>\n'
                }
            }
        }     
    }
    htmlout+="</table>"
    document.getElementById('contents').innerHTML = htmlout;
}
function clickElem(elem) {
      // Thx user1601638 on Stack Overflow (6/6/2018 - https://stackoverflow.com/questions/13405129/javascript-create-and-save-file )
      var eventMouse = document.createEvent("MouseEvents")
      eventMouse.initMouseEvent("click", true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null)
      elem.dispatchEvent(eventMouse)
}

function openFile(func) {
      readFile = function(e) {
          var file = e.target.files[0];
          if (!file) {
              return;
          }
          var reader = new FileReader();
          reader.onload = function(e) {
              var contents = e.target.result;
              fileInput.func(contents)
              document.body.removeChild(fileInput)
          }
          reader.readAsText(file)
      }
      fileInput = document.createElement("input")
      fileInput.type='file'
      fileInput.style.display='none'
      fileInput.onchange=readFile
      fileInput.func=func
      document.body.appendChild(fileInput)
      clickElem(fileInput)
}
</script>
<head>
    <style>
    table, th, td {
      border: 1px solid rgb(56, 56, 56);
      border-collapse: collapse;
    }
    </style>
    </head>
<body style="background-color:black; color:white">
<button id="file1button" onclick="openFile(loadFile1)">Select Before File</button>
<button id="file2button" onclick="openFile(loadFile2)">Select After File</button>
<pre id="contents"></pre>
</body>